<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Monitor - AI Fitness Trainer</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --primary-light: #e0e7ff;
            --secondary: #10b981;
            --secondary-dark: #059669;
            --secondary-light: #d1fae5;
            --dark: #1f2937;
            --light: #f9fafb;
            --gray: #6b7280;
            --danger: #ef4444;
            --warning: #f59e0b;
            --sidebar-width: 250px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: #f3f4f6;
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
        }
        
        .sidebar {
            width: var(--sidebar-width);
            background-color: white;
            height: 100vh;
            position: fixed;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        .sidebar-header {
            padding: 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #eee;
        }
        
        .sidebar-logo {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .sidebar-logo:hover {
            transform: scale(1.05);
        }
        
        .sidebar-logo i {
            margin-right: 10px;
        }
        
        .sidebar-menu {
            padding: 20px 0;
            flex: 1;
            overflow-y: auto;
        }
        
        .menu-category {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--gray);
            font-weight: 600;
            padding: 10px 20px;
            margin-top: 10px;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            position: relative;
        }
        
        .menu-item:hover, .menu-item.active {
            background-color: var(--primary-light);
            color: var(--primary);
            border-left-color: var(--primary);
        }
        
        .menu-item i {
            margin-right: 10px;
            font-size: 18px;
            transition: all 0.3s ease;
        }
        
        .menu-item:hover i, .menu-item.active i {
            transform: translateX(3px);
        }
        
        .sidebar-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-light);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 10px;
            transition: all 0.3s ease;
        }
        
        .user-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(79, 70, 229, 0.3);
        }
        
        .user-details {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .user-role {
            font-size: 12px;
            color: var(--gray);
        }
        
        .logout-btn {
            margin-left: 10px;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            color: var(--danger);
            transform: scale(1.2);
        }
        
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
            width: calc(100% - var(--sidebar-width));
            transition: all 0.3s ease;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
            position: relative;
            padding-bottom: 10px;
        }
        
        .page-title::after {
            content: '';
            position: absolute;
            width: 50px;
            height: 3px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            bottom: 0;
            left: 0;
            border-radius: 3px;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.1);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(79, 70, 229, 0.2);
        }
        
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.1);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 8px 15px rgba(16, 185, 129, 0.2);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            box-shadow: 0 4px 6px rgba(239, 68, 68, 0.1);
        }
        
        .btn-danger:hover {
            box-shadow: 0 8px 15px rgba(239, 68, 68, 0.2);
        }
        
        .webcam-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .video-container {
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            padding: 20px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .video-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .video-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .video-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .video-wrapper {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            overflow: hidden;
            border-radius: 10px;
            background-color: #000;
            transition: all 0.3s ease;
        }
        
        .video-wrapper:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .video-feed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .stats-container {
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            padding: 20px;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .stats-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .stats-header {
            margin-bottom: 20px;
        }
        
        .stats-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .stat-card {
            background-color: #f9fafb;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .detection-result {
            background: linear-gradient(135deg, var(--primary-light), #c7d2fe);
            color: var(--primary);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .detection-result:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(79, 70, 229, 0.2);
        }
        
        .detection-label {
            font-size: 14px;
            margin-bottom: 5px;
            color: var(--primary-dark);
        }
        
        .detection-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-dark);
        }
        
        .confidence-bars {
            margin-top: 20px;
        }
        
        .confidence-bar {
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .confidence-bar:hover {
            transform: translateX(5px);
        }
        
        .confidence-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .confidence-name {
            font-weight: 500;
            color: var(--dark);
        }
        
        .confidence-value {
            color: var(--gray);
        }
        
        .confidence-progress {
            height: 8px;
            background-color: #eee;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            border-radius: 4px;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .session-summary {
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-top: 20px;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .session-summary:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .summary-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .summary-card {
            background-color: #f9fafb;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .summary-icon {
            font-size: 24px;
            color: var(--primary);
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .summary-card:hover .summary-icon {
            transform: scale(1.2) rotate(10deg);
        }
        
        .summary-label {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 5px;
        }
        
        .summary-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .alert-warning {
            background-color: #fef3c7;
            color: var(--warning);
            border: 1px solid #fde68a;
        }
        
        /* Mobile menu toggle */
        .mobile-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 101;
            background-color: white;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .mobile-toggle:hover {
            background-color: var(--primary-light);
            color: var(--primary);
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .webcam-container {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            
            .mobile-toggle {
                display: block;
            }
            
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
        }
        
        /* Pose landmarks styling */
        .landmark {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #4f46e5;
            transform: translate(-50%, -50%);
        }
        
        .landmark-connection {
            position: absolute;
            height: 2px;
            background-color: #4f46e5;
            transform-origin: 0% 0%;
        }

        /* Exercise description message styling */
        .exercise-description {
            background: linear-gradient(135deg, var(--secondary-light), #a7f3d0);
            color: var(--secondary-dark);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
            font-size: 16px;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.1);
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .exercise-description i {
            margin-right: 10px;
            font-size: 20px;
        }
        
        .exercise-description:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(16, 185, 129, 0.2);
        }

        .alert-success {
            background-color: #d1fae5;
            color: var(--secondary-dark);
            border: 1px solid var(--secondary-light);
        }

        .alert-danger {
            background-color: #fecaca;
            color: var(--danger);
            border: 1px solid #fca5a5;
        }

        .alert ul {
            margin-top: 10px;
            margin-left: 20px;
            text-align: left;
        }

        .alert li {
            margin-bottom: 5px;
        }

        .mt-3 {
            margin-top: 15px;
        }

        .camera-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: #1f2937;
            color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .camera-placeholder i {
            font-size: 48px;
            margin-bottom: 15px;
            color: var(--primary-light);
        }

        .camera-placeholder h3 {
            margin-bottom: 10px;
            font-size: 18px;
        }

        .camera-placeholder p {
            font-size: 14px;
            opacity: 0.8;
            max-width: 80%;
        }

        .debug-info {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
            display: none;
        }

        .debug-info.show {
            display: block;
        }

        .debug-toggle {
            font-size: 12px;
            color: var(--gray);
            text-decoration: underline;
            cursor: pointer;
            margin-top: 10px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="/" class="sidebar-logo">
                <i class="fas fa-dumbbell"></i>
                AI Fitness Trainer
            </a>
        </div>
        
        <div class="sidebar-menu">
            <div class="menu-category">Main</div>
            <a href="/dashboard" class="menu-item">
                <i class="fas fa-tachometer-alt"></i>
                Dashboard
            </a>
            <a href="/video_detection" class="menu-item">
                <i class="fas fa-video"></i>
                Video Detection
            </a>
            <a href="/live_monitor" class="menu-item active">
                <i class="fas fa-camera"></i>
                Live Monitor
            </a>
            
            <div class="menu-category">Account</div>
            <a href="/profile" class="menu-item">
                <i class="fas fa-user"></i>
                Profile
            </a>
            <a href="/workout_history" class="menu-item">
                <i class="fas fa-history"></i>
                Workout History
            </a>
            <a href="/achievements" class="menu-item">
                <i class="fas fa-medal"></i>
                Achievements
            </a>
            <a href="/settings" class="menu-item">
                <i class="fas fa-cog"></i>
                Settings
            </a>
        </div>
        
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar">
                    {{ session.username[0] }}
                </div>
                <div class="user-details">
                    <div class="user-name">{{ session.username }}</div>
                    <div class="user-role">Member</div>
                </div>
                <a href="/logout" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="page-header">
            <h1 class="page-title">Live Exercise Monitor</h1>
            <a href="/dashboard" class="btn">
                <i class="fas fa-arrow-left"></i>
                Back to Dashboard
            </a>
        </div>
        
        <div class="alert alert-warning" id="cameraAlert">
            <i class="fas fa-spinner fa-spin"></i>
            Initializing camera... Please wait.
        </div>
        
        <div class="webcam-container">
            <div class="video-container">
                <div class="video-header">
                    <h2 class="video-title">Live Camera Feed</h2>
                    <div id="fpsCounter">FPS: 0</div>
                </div>
                
                <div class="video-wrapper">
                    <video id="videoElement" class="video-feed" autoplay playsinline muted></video>
                    <canvas id="outputCanvas" class="video-feed" style="display: none;"></canvas>
                    <div id="landmarksContainer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></div>
                    <div id="cameraPlaceholder" class="camera-placeholder">
                        <i class="fas fa-camera"></i>
                        <h3>Camera Not Connected</h3>
                        <p>Please allow camera access when prompted or click the retry button below.</p>
                    </div>
                </div>
                
                <div class="video-controls">
                    <button class="btn" id="startBtn" disabled>
                        <i class="fas fa-play"></i>
                        Start Monitoring
                    </button>
                    <button class="btn btn-danger" id="stopBtn" disabled>
                        <i class="fas fa-stop"></i>
                        Stop
                    </button>
                    <button class="btn btn-secondary" id="saveBtn" disabled>
                        <i class="fas fa-save"></i>
                        Save Workout
                    </button>
                </div>
                
                <div class="debug-info" id="debugInfo"></div>
                <span class="debug-toggle" id="debugToggle">Show Debug Info</span>
            </div>
            
            <div class="stats-container">
                <div class="stats-header">
                    <h2 class="stats-title">Real-time Stats</h2>
                </div>
                
                <div class="detection-result">
                    <div class="detection-label">Current Exercise</div>
                    <div class="detection-value" id="currentExercise">Not Started</div>
                </div>
                
                <!-- Exercise description message -->
                <div class="exercise-description" id="exerciseDescription" style="display: none;">
                    <i class="fas fa-info-circle"></i>
                    <span id="exerciseDescriptionText">Start exercising to see feedback</span>
                </div>
                
                <div class="confidence-bars" id="confidenceBars">
                    <div class="confidence-bar">
                        <div class="confidence-label">
                            <div class="confidence-name">Jumping Jacks</div>
                            <div class="confidence-value" id="jumping_jacks_confidence">0%</div>
                        </div>
                        <div class="confidence-progress">
                            <div class="confidence-fill" id="jumping_jacks_fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="confidence-bar">
                        <div class="confidence-label">
                            <div class="confidence-name">Push Ups</div>
                            <div class="confidence-value" id="push_ups_confidence">0%</div>
                        </div>
                        <div class="confidence-progress">
                            <div class="confidence-fill" id="push_ups_fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="confidence-bar">
                        <div class="confidence-label">
                            <div class="confidence-name">Rotating Toe Touches</div>
                            <div class="confidence-value" id="rotating_toe_touches_confidence">0%</div>
                        </div>
                        <div class="confidence-progress">
                            <div class="confidence-fill" id="rotating_toe_touches_fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="confidence-bar">
                        <div class="confidence-label">
                            <div class="confidence-name">Squats</div>
                            <div class="confidence-value" id="squats_confidence">0%</div>
                        </div>
                        <div class="confidence-progress">
                            <div class="confidence-fill" id="squats_fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Session Duration</div>
                        <div class="stat-value" id="sessionDuration">00:00</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-label">Estimated Calories</div>
                        <div class="stat-value" id="estimatedCalories">0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="session-summary" id="sessionSummary" style="display: none;">
            <div class="summary-header">
                <h2 class="summary-title">Workout Summary</h2>
            </div>
            
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-icon">
                        <i class="fas fa-dumbbell"></i>
                    </div>
                    <div class="summary-label">Primary Exercise</div>
                    <div class="summary-value" id="summaryExercise">-</div>
                </div>
                
                <div class="summary-card">
                    <div class="summary-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="summary-label">Total Duration</div>
                    <div class="summary-value" id="summaryDuration">-</div>
                </div>
                
                <div class="summary-card">
                    <div class="summary-icon">
                        <i class="fas fa-fire"></i>
                    </div>
                    <div class="summary-label">Calories Burned</div>
                    <div class="summary-value" id="summaryCalories">-</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const videoElement = document.getElementById('videoElement');
            const outputCanvas = document.getElementById('outputCanvas');
            const landmarksContainer = document.getElementById('landmarksContainer');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const saveBtn = document.getElementById('saveBtn');
            const cameraAlert = document.getElementById('cameraAlert');
            const fpsCounter = document.getElementById('fpsCounter');
            const currentExercise = document.getElementById('currentExercise');
            const sessionDuration = document.getElementById('sessionDuration');
            const estimatedCalories = document.getElementById('estimatedCalories');
            const sessionSummary = document.getElementById('sessionSummary');
            const summaryExercise = document.getElementById('summaryExercise');
            const summaryDuration = document.getElementById('summaryDuration');
            const summaryCalories = document.getElementById('summaryCalories');
            const exerciseDescription = document.getElementById('exerciseDescription');
            const exerciseDescriptionText = document.getElementById('exerciseDescriptionText');
            const cameraPlaceholder = document.getElementById('cameraPlaceholder');
            const debugInfo = document.getElementById('debugInfo');
            const debugToggle = document.getElementById('debugToggle');
            
            // Variables
            let stream = null;
            let isMonitoring = false;
            let startTime = null;
            let sessionTimer = null;
            let processingFrame = false;
            let lastFrameTime = 0;
            let fps = 0;
            let frameCount = 0;
            let exerciseCounts = {
                'jumping_jacks': 0,
                'push_ups': 0,
                'rotating_toe_touches': 0,
                'squats': 0
            };
            let totalCalories = 0;
            let caloriesPerMinute = {
                'jumping_jacks': 8,
                'push_ups': 7,
                'rotating_toe_touches': 6,
                'squats': 8
            };
            let retryCount = 0;
            let maxRetries = 3;
            let debugMode = false;
            
            // Exercise descriptions
            const exerciseDescriptions = {
                'jumping_jacks': [
                    "You're doing jumping jacks! Keep your arms straight as they move above your head.",
                    "Great form on those jumping jacks! Remember to fully extend your arms and legs.",
                    "Jumping jacks are great for cardio! Keep up the pace and maintain your rhythm."
                ],
                'push_ups': [
                    "You're doing push-ups! Keep your core tight and back straight.",
                    "Good push-up form! Remember to lower your chest close to the ground and push back up.",
                    "Push-ups work your chest, shoulders, and triceps. Maintain a steady pace!"
                ],
                'rotating_toe_touches': [
                    "You're doing rotating toe touches! Reach for those toes while maintaining balance.",
                    "Great toe touches! Remember to engage your core as you rotate and reach.",
                    "Rotating toe touches help improve flexibility and core strength. Keep it up!"
                ],
                'squats': [
                    "You're doing squats! Keep your back straight and knees behind your toes.",
                    "Good squat form! Lower until your thighs are parallel to the ground.",
                    "Squats are excellent for building leg strength. Remember to breathe out as you rise!"
                ]
            };
            
            // Debug logging
            function logDebug(message) {
                const timestamp = new Date().toLocaleTimeString();
                const logMessage = `[${timestamp}] ${message}`;
                console.log(logMessage);
                
                // Add to debug info panel
                const logElement = document.createElement('div');
                logElement.textContent = logMessage;
                debugInfo.appendChild(logElement);
                
                // Auto-scroll to bottom
                debugInfo.scrollTop = debugInfo.scrollHeight;
            }
            
            // Toggle debug info
            debugToggle.addEventListener('click', function() {
                debugMode = !debugMode;
                debugInfo.classList.toggle('show');
                debugToggle.textContent = debugMode ? 'Hide Debug Info' : 'Show Debug Info';
            });
            
            // Setup canvas
            const ctx = outputCanvas.getContext('2d');
            
            // Function to reset all progress
            function resetProgress() {
                // Reset exercise counts
                exerciseCounts = {
                    'jumping_jacks': 0,
                    'push_ups': 0,
                    'rotating_toe_touches': 0,
                    'squats': 0
                };
                
                // Reset calories
                totalCalories = 0;
                estimatedCalories.textContent = '0';
                
                // Reset session duration
                sessionDuration.textContent = '00:00';
                
                // Reset current exercise
                currentExercise.textContent = 'Not Started';
                
                // Reset confidence bars
                resetConfidenceBars();
                
                // Clear landmarks
                landmarksContainer.innerHTML = '';
                
                // Hide exercise description
                exerciseDescription.style.display = 'none';
            }
            
            // Function to reset confidence bars
            function resetConfidenceBars() {
                document.getElementById('jumping_jacks_confidence').textContent = '0%';
                document.getElementById('push_ups_confidence').textContent = '0%';
                document.getElementById('rotating_toe_touches_confidence').textContent = '0%';
                document.getElementById('squats_confidence').textContent = '0%';
                
                document.getElementById('jumping_jacks_fill').style.width = '0%';
                document.getElementById('push_ups_fill').style.width = '0%';
                document.getElementById('rotating_toe_touches_fill').style.width = '0%';
                document.getElementById('squats_fill').style.width = '0%';
            }
            
            // Initialize camera
            async function initCamera() {
                try {
                    logDebug('Initializing camera...');
                    
                    // First, check if the browser supports getUserMedia
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('Your browser does not support camera access. Please try a different browser like Chrome or Firefox.');
                    }
                    
                    // Clear any previous error messages
                    cameraAlert.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Requesting camera access...';
                    cameraAlert.style.display = 'block';
                    cameraAlert.className = 'alert alert-warning';
                    
                    // Show camera placeholder
                    cameraPlaceholder.style.display = 'flex';
                    
                    // Request camera access with specific constraints
                    logDebug('Requesting camera access...');
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: 'user'
                        },
                        audio: false
                    });
                    
                    logDebug('Camera access granted!');
                    
                    // Set the video source to the camera stream
                    videoElement.srcObject = stream;
                    
                    // Hide camera placeholder
                    cameraPlaceholder.style.display = 'none';
                    
                    // Success message
                    cameraAlert.innerHTML = '<i class="fas fa-check-circle"></i> Camera connected successfully!';
                    cameraAlert.className = 'alert alert-success';
                    
                    // Hide the alert after 3 seconds
                    setTimeout(() => {
                        cameraAlert.style.display = 'none';
                    }, 3000);
                    
                    // Wait for the video to be loaded
                    videoElement.onloadedmetadata = () => {
                        // Set canvas size to match video dimensions
                        outputCanvas.width = videoElement.videoWidth;
                        outputCanvas.height = videoElement.videoHeight;
                        logDebug(`Camera initialized successfully. Video dimensions: ${videoElement.videoWidth} x ${videoElement.videoHeight}`);
                        
                        // Enable start button
                        startBtn.disabled = false;
                    };
                    
                    // Make sure the video plays
                    try {
                        await videoElement.play();
                        logDebug('Video playback started');
                    } catch (playError) {
                        logDebug(`Error starting video playback: ${playError.message}`);
                        // Try again with user interaction
                        videoElement.addEventListener('click', () => {
                            videoElement.play().catch(e => logDebug(`Play on click failed: ${e.message}`));
                        });
                    }
                    
                    // Reset retry count on success
                    retryCount = 0;
                    
                } catch (err) {
                    logDebug(`Error accessing camera: ${err.message}`);
                    
                    // Provide detailed error message with troubleshooting steps
                    let errorMessage = `<i class="fas fa-exclamation-triangle"></i> <strong>Camera Error:</strong> ${err.message}<br><br>`;
                    errorMessage += '<strong>Troubleshooting steps:</strong><ul>';
                    errorMessage += '<li>Make sure you\'ve granted camera permissions when prompted</li>';
                    errorMessage += '<li>Check if another application is using your camera</li>';
                    errorMessage += '<li>Try refreshing the page</li>';
                    errorMessage += '<li>Make sure you\'re using a modern browser (Chrome, Firefox, Edge)</li>';
                    errorMessage += '<li>If using a secure site (HTTPS), check your camera settings in browser</li>';
                    errorMessage += '</ul>';
                    
                    cameraAlert.innerHTML = errorMessage;
                    cameraAlert.className = 'alert alert-danger';
                    cameraAlert.style.display = 'block';
                    
                    // Show camera placeholder
                    cameraPlaceholder.style.display = 'flex';
                    
                    // Auto-retry if we haven't exceeded max retries
                    if (retryCount < maxRetries) {
                        retryCount++;
                        logDebug(`Retry attempt ${retryCount} of ${maxRetries} in 3 seconds...`);
                        setTimeout(initCamera, 3000);
                    }
                }
            }
            
            // Check camera status and retry if needed
            function checkCameraStatus() {
                if (!stream || !videoElement.srcObject) {
                    logDebug('Camera not initialized, retrying...');
                    initCamera();
                } else {
                    // Check if the camera is actually streaming
                    const tracks = stream.getVideoTracks();
                    if (!tracks || tracks.length === 0 || !tracks[0].enabled || tracks[0].readyState !== 'live') {
                        logDebug('Camera track not active, retrying...');
                        // Close existing stream first
                        stopCamera();
                        initCamera();
                    } else {
                        logDebug('Camera is working properly');
                    }
                }
            }
            
            // Stop camera
            function stopCamera() {
                if (stream) {
                    logDebug('Stopping camera stream...');
                    stream.getTracks().forEach(track => {
                        track.stop();
                    });
                    videoElement.srcObject = null;
                    stream = null;
                }
            }
            
            // Start monitoring
            function startMonitoring() {
                if (!stream) {
                    alert('Camera not available. Please allow camera access and refresh the page.');
                    return;
                }
                
                logDebug('Starting monitoring...');
                isMonitoring = true;
                startBtn.disabled = true;
                stopBtn.disabled = false;
                saveBtn.disabled = true;
                
                // Show the output canvas and hide the video element
                videoElement.style.display = 'none';
                outputCanvas.style.display = 'block';
                
                // Reset all progress to initial state
                resetProgress();
                
                // Set start time
                startTime = new Date();
                
                // Start session timer
                sessionTimer = setInterval(updateSessionTime, 1000);
                
                // Hide summary
                sessionSummary.style.display = 'none';
                
                // Start processing frames
                requestAnimationFrame(processFrame);
            }
            
            // Stop monitoring
            function stopMonitoring() {
                logDebug('Stopping monitoring...');
                isMonitoring = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                saveBtn.disabled = false;
                
                // Show the video element and hide the output canvas
                videoElement.style.display = 'block';
                outputCanvas.style.display = 'none';
                
                // Stop session timer
                clearInterval(sessionTimer);
                
                // Calculate summary
                const duration = Math.floor((new Date() - startTime) / 1000);
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                
                // Find primary exercise
                let primaryExercise = 'None';
                let maxCount = 0;
                
                for (const [exercise, count] of Object.entries(exerciseCounts)) {
                    if (count > maxCount) {
                        maxCount = count;
                        primaryExercise = exercise;
                    }
                }
                
                // Update summary
                summaryExercise.textContent = primaryExercise.replace(/_/g, ' ').toUpperCase();
                summaryDuration.textContent = `${minutes}m ${seconds}s`;
                summaryCalories.textContent = totalCalories;
                
                // Show summary
                sessionSummary.style.display = 'block';
                
                // Clear landmarks
                landmarksContainer.innerHTML = '';
                
                // Hide exercise description
                exerciseDescription.style.display = 'none';
            }
            
            // Save workout
            function saveWorkout() {
                if (!startTime) {
                    alert('No workout data to save.');
                    return;
                }
                
                logDebug('Saving workout...');
                const duration = Math.floor((new Date() - startTime) / 1000);
                
                // Find primary exercise
                let primaryExercise = 'None';
                let maxCount = 0;
                
                for (const [exercise, count] of Object.entries(exerciseCounts)) {
                    if (count > maxCount) {
                        maxCount = count;
                        primaryExercise = exercise;
                    }
                }
                
                // Send data to server
                fetch('/save_workout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        exercise_type: primaryExercise,
                        duration: duration,
                        calories: totalCalories
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert('Workout saved successfully!');
                        saveBtn.disabled = true;
                        logDebug('Workout saved successfully');
                    } else {
                        alert('Error saving workout: ' + data.error);
                        logDebug(`Error saving workout: ${data.error}`);
                    }
                })
                .catch(error => {
                    alert('Error saving workout: ' + error.message);
                    logDebug(`Error saving workout: ${error.message}`);
                });
            }
            
            // Process frame
            function processFrame() {
                if (!isMonitoring) return;
                
                // Calculate FPS
                const now = performance.now();
                frameCount++;
                
                if (now - lastFrameTime >= 1000) {
                    fps = Math.round((frameCount * 1000) / (now - lastFrameTime));
                    fpsCounter.textContent = `FPS: ${fps}`;
                    frameCount = 0;
                    lastFrameTime = now;
                }
                
                try {
                    // Draw video to canvas
                    ctx.drawImage(videoElement, 0, 0, outputCanvas.width, outputCanvas.height);
                    
                    // Process frame if not already processing
                    if (!processingFrame) {
                        processingFrame = true;
                        
                        // Get frame data
                        outputCanvas.toBlob(function(blob) {
                            if (!blob) {
                                logDebug('Failed to create blob from canvas');
                                processingFrame = false;
                                requestAnimationFrame(processFrame);
                                return;
                            }
                            
                            const reader = new FileReader();
                            reader.onloadend = function() {
                                const base64data = reader.result;
                                
                                // Send to server for processing
                                fetch('/process_frame', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        image: base64data
                                    })
                                })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error(`Server responded with status: ${response.status}`);
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    if (data.success) {
                                        // Update video with processed frame
                                        const img = new Image();
                                        img.crossOrigin = "anonymous";
                                        img.onload = function() {
                                            ctx.drawImage(img, 0, 0, outputCanvas.width, outputCanvas.height);
                                        };
                                        img.src = 'data:image/jpeg;base64,' + data.processed_image;
                                        
                                        // Update exercise detection
                                        if (data.pose_detected) {
                                            // Display pose landmarks
                                            if (data.pose_landmarks) {
                                                displayPoseLandmarks(data.pose_landmarks);
                                            }
                                            
                                            if (data.predicted_class) {
                                                // Update current exercise
                                                currentExercise.textContent = data.predicted_class.replace(/_/g, ' ').toUpperCase();
                                                
                                                // Update exercise counts
                                                exerciseCounts[data.predicted_class]++;
                                                
                                                // Update confidence bars
                                                updateConfidenceBars(data.predicted_class, data.confidence);
                                                
                                                // Update calories
                                                const elapsedMinutes = (new Date() - startTime) / 60000;
                                                totalCalories = Math.round(
                                                    Object.entries(exerciseCounts).reduce((total, [exercise, count]) => {
                                                        return total + (count * caloriesPerMinute[exercise] / 10);
                                                    }, 0)
                                                );
                                                estimatedCalories.textContent = totalCalories;
                                                
                                                // Update exercise description
                                                updateExerciseDescription(data.predicted_class);
                                            }
                                        } else {
                                            currentExercise.textContent = 'No Pose Detected';
                                            // Clear landmarks when no pose is detected
                                            landmarksContainer.innerHTML = '';
                                            // Hide exercise description
                                            exerciseDescription.style.display = 'none';
                                        }
                                        
                                        processingFrame = false;
                                    } else {
                                        logDebug(`Error processing frame: ${data.error || 'Unknown error'}`);
                                        processingFrame = false;
                                    }
                                })
                                .catch(error => {
                                    logDebug(`Error sending frame: ${error.message}`);
                                    processingFrame = false;
                                });
                            };
                            
                            reader.onerror = function() {
                                logDebug('Error reading blob as data URL');
                                processingFrame = false;
                            };
                            
                            reader.readAsDataURL(blob);
                        }, 'image/jpeg', 0.8);
                    }
                } catch (error) {
                    logDebug(`Error in processFrame: ${error.message}`);
                    processingFrame = false;
                }
                
                // Continue processing frames
                requestAnimationFrame(processFrame);
            }
            
            // Update exercise description
            function updateExerciseDescription(exerciseType) {
                if (exerciseType && exerciseDescriptions[exerciseType]) {
                    // Get random description from the array for this exercise
                    const descriptions = exerciseDescriptions[exerciseType];
                    const randomIndex = Math.floor(Math.random() * descriptions.length);
                    exerciseDescriptionText.textContent = descriptions[randomIndex];
                    exerciseDescription.style.display = 'flex';
                } else {
                    exerciseDescription.style.display = 'none';
                }
            }
            
            // Display pose landmarks
            function displayPoseLandmarks(landmarks) {
                // Clear previous landmarks
                landmarksContainer.innerHTML = '';
                
                // Get container dimensions
                const containerWidth = landmarksContainer.offsetWidth;
                const containerHeight = landmarksContainer.offsetHeight;
                
                // Create landmarks
                landmarks.forEach((landmark, index) => {
                    const x = landmark.x * containerWidth;
                    const y = landmark.y * containerHeight;
                    
                    const landmarkElement = document.createElement('div');
                    landmarkElement.className = 'landmark';
                    landmarkElement.style.left = `${x}px`;
                    landmarkElement.style.top = `${y}px`;
                    
                    landmarksContainer.appendChild(landmarkElement);
                });
                
                // Draw connections between landmarks
                const connections = [
                    // Torso
                    [11, 12], [12, 24], [24, 23], [23, 11],
                    // Right arm
                    [12, 14], [14, 16],
                    // Left arm
                    [11, 13], [13, 15],
                    // Right leg
                    [24, 26], [26, 28],
                    // Left leg
                    [23, 25], [25, 27]
                ];
                
                connections.forEach(([i, j]) => {
                    if (landmarks[i] && landmarks[j]) {
                        const x1 = landmarks[i].x * containerWidth;
                        const y1 = landmarks[i].y * containerHeight;
                        const x2 = landmarks[j].x * containerWidth;
                        const y2 = landmarks[j].y * containerHeight;
                        
                        const length = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
                        const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
                        
                        const connectionElement = document.createElement('div');
                        connectionElement.className = 'landmark-connection';
                        connectionElement.style.width = `${length}px`;
                        connectionElement.style.left = `${x1}px`;
                        connectionElement.style.top = `${y1}px`;
                        connectionElement.style.transform = `rotate(${angle}deg)`;
                        
                        landmarksContainer.appendChild(connectionElement);
                    }
                });
            }
            
            // Update confidence bars
            function updateConfidenceBars(predictedClass, confidence) {
                // Reset all confidence values to 0%
                document.getElementById('jumping_jacks_confidence').textContent = '0%';
                document.getElementById('push_ups_confidence').textContent = '0%';
                document.getElementById('rotating_toe_touches_confidence').textContent = '0%';
                document.getElementById('squats_confidence').textContent = '0%';
                
                // Reset all fill bars to 0%
                document.getElementById('jumping_jacks_fill').style.width = '0%';
                document.getElementById('push_ups_fill').style.width = '0%';
                document.getElementById('rotating_toe_touches_fill').style.width = '0%';
                document.getElementById('squats_fill').style.width = '0%';
                
                // Update the predicted class confidence
                if (predictedClass) {
                    const percent = Math.round(confidence * 100);
                    document.getElementById(`${predictedClass}_confidence`).textContent = `${percent}%`;
                    document.getElementById(`${predictedClass}_fill`).style.width = `${percent}%`;
                }
            }
            
            // Update session time
            function updateSessionTime() {
                if (!startTime) return;
                
                const elapsed = Math.floor((new Date() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const seconds = (elapsed % 60).toString().padStart(2, '0');
                
                sessionDuration.textContent = `${minutes}:${seconds}`;
            }
            
            // Add a retry button to the camera alert
            const retryButton = document.createElement('button');
            retryButton.className = 'btn btn-secondary mt-3';
            retryButton.innerHTML = '<i class="fas fa-sync"></i> Retry Camera Connection';
            retryButton.onclick = function() {
                logDebug('Manual camera retry requested');
                stopCamera();
                initCamera();
            };
            cameraAlert.appendChild(retryButton);
            
            // Event listeners
            startBtn.addEventListener('click', startMonitoring);
            stopBtn.addEventListener('click', stopMonitoring);
            saveBtn.addEventListener('click', saveWorkout);
            
            // Handle page visibility changes
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'visible') {
                    logDebug('Page is now visible, checking camera status');
                    checkCameraStatus();
                }
            });
            
            // Initialize camera on page load
            logDebug('Page loaded, initializing camera');
            initCamera();
            
            // Check camera status after 3 seconds
            setTimeout(checkCameraStatus, 3000);
        });
    </script>
</body>
</html>
